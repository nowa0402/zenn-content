---
title: "pytestã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ãªãƒ†ã‚¹ãƒˆã‚’è¡Œã†"
emoji: "ğŸ—ƒï¸"
type: "tech"
topics:
  - "python"
  - "pytest"
  - "pydantic"
published: true
published_at: "2023-07-08 14:00"
---

## tempfile Ã— pytestã‚’çµ„ã¿åˆã‚ã›ã‚‹

pytestã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ãéš›ã€ä»¥ä¸‹ã®çŠ¶æ³ã«é­é‡ã—ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ã€‚

- ä¸€æ™‚çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã„
- ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ãŸã„

ä»£è¡¨ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å‡¦ç†ã‚’è¡Œã†ã‚³ãƒ¼ãƒ‰ã ã¨æ€ã„ã¾ã™ã€‚
ãã‚“ãªæ™‚ã¯`tempfile`ã‚’ä½¿ã†ã¨ã„ã„æ„Ÿã˜ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```bash
.
â”œâ”€â”€ csv_read.py
â””â”€â”€ tests
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_csv_read.py
```

- csv_read.py ä»Šå›ã®ãƒ†ã‚¹ãƒˆå¯¾è±¡
- test_csv_read.py ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

## ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ä»¥ä¸‹ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

- pytest
- pydanticï¼ˆãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¯ãƒ©ã‚¹ã«ä½¿ç”¨ï¼‰

## ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã‚¯ãƒ©ã‚¹

ä»Šå›ã¯ã€CSVã‚’èª­ã¿è¾¼ã‚€äº‹ã‚’æƒ³å®šã—ãŸã‚¯ãƒ©ã‚¹ã‚’æº–å‚™ã—ã¾ã—ãŸã€‚
ã“ã®å†…ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹éš›ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

```python:csv_read.py
from pathlib import Path

from pydantic import BaseModel, Field, validator


class CSVReader(BaseModel):
    """CSVèª­ã¿è¾¼ã¿ã‚¯ãƒ©ã‚¹"""

    path: Path = Field(..., description="CSVãƒ‘ã‚¹")

    @validator("path")
    def validate_path(cls, path: Path) -> Path:
        """ãƒ‘ã‚¹æ¤œæŸ»

        Args:
            path (Path): CSVãƒ‘ã‚¹

        Raises:
            ValueError: æ¤œè¨¼å¤±æ•—

        Returns:
            Path: CSVãƒ‘ã‚¹
        """
        # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨æ¤œè¨¼
        if not path.exists():
            raise ValueError(f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“:{path}")

        # æ‹¡å¼µå­æ¤œè¨¼
        if path.suffix != ".csv":
            raise ValueError(f"æ‹¡å¼µå­ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™:{path.name}")

        return path

```

`pydantic`ã®`validator`ã¯ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã«ã™ã‚‹ã“ã¨ã§
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–å‰ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
https://docs.pydantic.dev/1.10/usage/validators/

ä¸Šè¨˜ã§ã¯2ç‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã‹
- æ‹¡å¼µå­ãŒ`.csv`ã‹

ã“ã‚Œã‚‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆå®Ÿè£…

å…ˆç¨‹ã®ã‚¯ãƒ©ã‚¹ã‚’`tempfile`ã§ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

### tempfileã«ã¤ã„ã¦

å®Ÿè£…å‰ã«`tempfile`ã«ã¤ã„ã¦ç°¡å˜ã«è§£èª¬ã—ã¾ã™ã€‚
`tempfile`ã¯èª­ã‚“ã§å­—ã®å¦‚ãã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã™ã‚‹æ“ä½œã‚’è¡Œã†æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚
è©³ã—ã„ä½¿ã„æ–¹ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://zenn.dev/alivelimb/articles/20220506-tempfile

`NamedTemporaryFile`ã‚’ä½¿ã†ã¨ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚ŒãŸãƒ‘ã‚¹ã‚’å–å¾—ã§ãã¾ã™ã€‚
`suffix`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«æ‹¡å¼µå­ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ä»»æ„ã®æ‹¡å¼µå­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã§ãã¾ã™ã€‚

```python
import tempfile

# /tmp/{tempfile_name}.csv
print(tempfile.NamedTemporaryFile(suffix=".csv", delete=True).name)
```

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

ã§ã¯ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
- æ‹¡å¼µå­ãŒèª¤ã£ã¦ã„ã‚‹
- æ¤œè¨¼é€šé
ã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…ã—ã¾ã—ãŸã€‚

```python:test_csv_read.py
import tempfile
from pathlib import Path
from typing import Any, Generator

import pytest
from pydantic import ValidationError

from csv_read import CSVReader


@pytest.fixture(scope="function")
def json_file() -> Generator[Path, Any, None]:
    """jsonä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

    Yields:
        Generator[Path, Any, None]: jsonä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    path = Path(tempfile.NamedTemporaryFile(suffix=".json", delete=False).name)
    yield path
    # ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    path.unlink()


@pytest.fixture(scope="function")
def csv_file() -> Generator[Path, Any, None]:
    """csvä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

    Yields:
        Generator[Path, Any, None]: csvä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    path = Path(tempfile.NamedTemporaryFile(suffix=".csv", delete=False).name)
    yield path
    # ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    path.unlink()


def test_not_exists_path() -> None:
    """ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼
    ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
    """
    path = Path(tempfile.NamedTemporaryFile(suffix=".csv", delete=True).name)
    with pytest.raises(ValidationError) as e:
        _ = CSVReader(path=path)

    msg = e.value.errors()[0]["msg"]
    assert msg == f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“:{path}"


def test_not_suffix_csv(json_file: Path) -> None:
    """ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
    æ‹¡å¼µå­ä¸æ­£

    Args:
        json_file (Path): jsonä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    with pytest.raises(ValidationError) as e:
        _ = CSVReader(path=json_file)

    msg = e.value.errors()[0]["msg"]
    assert msg == f"æ‹¡å¼µå­ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™:{json_file.name}"


def test_validate_ok(csv_file: Path) -> None:
    """ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯é€šé

    Args:
        csv_file (Path): csvä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    reader = CSVReader(path=csv_file)
    assert reader.path == csv_file

```

ãƒã‚¤ãƒ³ãƒˆã‚’ã„ãã¤ã‹ã”ç´¹ä»‹ã—ã¾ã™ã€‚

#### ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¨å‰Šé™¤

`pytest.fixture`ã‚’ä½¿ã£ã¦

- ä½œæˆã‚’è¡Œã†å‰å‡¦ç†
- å‰Šé™¤ã‚’è¡Œã†å¾Œå‡¦ç†

ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```python:test_csv_read.py
@pytest.fixture(scope="function")
def json_file() -> Generator[Path, Any, None]:
    """jsonä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

    Yields:
        Generator[Path, Any, None]: jsonä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    """
    path = Path(tempfile.NamedTemporaryFile(suffix=".json", delete=False).name)
    # ãƒ†ã‚¹ãƒˆé–¢æ•°ã«ãƒ‘ã‚¹ã‚’è¿”å´
    yield path
    # ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    path.unlink()

```

`NamedTemporaryFile().name`ã§ãƒ‘ã‚¹ã‚’å–å¾—ã—ãŸå¾Œã€`pathlib.Path`ã§ãƒ‘ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
`delete=False`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã›ãšã«ä¿æŒã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

`pathlib`ã¯ãƒ‘ã‚¹é–¢ä¿‚ã®å‡¦ç†ã‚’ç››ã‚Šè¾¼ã‚“ã§ã„ã‚‹æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚
ãƒ‘ã‚¹ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ„Ÿè¦šã§æ“ä½œå‡ºæ¥ã‚‹ãŸã‚ã€ãƒ‘ã‚¹ã®å‡¦ç†ã‚’ã—ãŸã„ãªã‚‰æ˜¯éä½¿ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
https://docs.python.org/ja/3/library/pathlib.html

`yield`ã§æœ¬å‡¦ç†ã«ãƒ‘ã‚¹ã‚’è¿”å´ã—ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã¯`path.unlink()`ã§è‡ªèº«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã€å¾Œå‡¦ç†ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚

#### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’æ‹¾ã†

`pytest.raises()`ã§æ‹¾ã„ã¾ã™ã€‚

```python:test_csv_read.py
def test_not_exists_path() -> None:
    """ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼
    ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
    """
    path = Path(tempfile.NamedTemporaryFile(suffix=".csv", delete=True).name)
    with pytest.raises(ValidationError) as e:
        _ = CSVReader(path=path)

    msg = e.value.errors()[0]["msg"]
    assert msg == f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“:{path}"

```

`pydantic.ValidationError`ã§ã‚¨ãƒ©ãƒ¼å—ã‘ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¢ºèªã‚’ã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

pytestã‚’ä½¿ã£ã¦å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦ãªãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚

- tempfileã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
- pytest.fixtureã§å‰å‡¦ç†ã¨å¾Œå‡¦ç†ã‚’å®Ÿç¾ã™ã‚‹

ã“ã‚Œã‚‰ã‚’æ´»ç”¨ã™ã‚Œã°ã€ä¸€æ™‚çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï½å‰Šé™¤ã¾ã§ã‚’ã“ãªã™ã“ã¨ãŒã§ãã¾ã™ã€‚
æ˜¯éè©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### è¿½è¨˜

åŸ·ç­†ä¸­ã€pytestã«tmp_pathã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚‹ã“ã¨ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚
https://docs.pytest.org/en/7.1.x/how-to/tmp_path.html
ã“ã‚Œã‚’æ´»ç”¨ã™ã‚Œã°ã€ã‚‚ã†å°‘ã—æ¥½ã«æ›¸ã‘ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ä½¿ãˆãã†ã§ã‚ã‚Œã°è¨˜äº‹ã«è¿½è¨˜ã—ã¦ãŠãã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

- [pytest(doc)](https://docs.pytest.org/en/7.1.x/contents.html)
- [tempfile](https://docs.python.org/ja/3/library/tempfile.html)
- [pathlib](https://docs.python.org/ja/3/library/pathlib.html)
- [pathlibã¯ã„ã„ã](https://zenn.dev/alivelimb/articles/0f3f8d61d91d57)
- [pydantic(doc)](https://docs.pydantic.dev/latest/)
