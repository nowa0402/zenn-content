---
title: "FastAPIã§404ã‚¨ãƒ©ãƒ¼ã‚’è‡ªåœ¨ã«ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹"
emoji: "ğŸ¦•"
type: "tech"
topics:
  - "python"
  - "fastapi"
  - "pydantic"
published: true
published_at: "2023-06-24 12:00"
---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„

FastAPIã¯å­˜åœ¨ã—ãªã„URLã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨
`{"detail":"Not Found"}`
ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¿”å´ã•ã‚Œã‚‹ã€‚

ã“ã‚Œã‚’å¥½ããªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ•´å½¢ã—ã¦è¿”å´ã—ã¦ã¿ã‚‹ã€‚

## å®Ÿè£…æ–¹æ³•

### å®Ÿè£…å‰

ã¨ã‚Šã‚ãˆãšæ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã€‚
ã“ã“ã‹ã‚‰ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¦ã„ãã€‚

```python:main.py
import uvicorn
from fastapi import FastAPI

app = FastAPI()


@app.get("/hello")
def hello_world() -> dict[str, str]:
    return {"hello": "world"}


def main() -> None:
    uvicorn.run("main:app", port=8000, host="0.0.0.0", reload=True)


if __name__ == "__main__":
    main()
```

`python {ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å}`ã§APIã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦å‹•ä½œç¢ºèªã€‚

```bash
# /hello GET
$ curl 127.0.0.1:8000/hello
{"hello":"world"}

# /user GET (å­˜åœ¨ã—ãªã„)
$ curl 127.0.0.1:8000/user
{"detail":"Not Found"}
```

`/hello`ã¯å®šç¾©ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
`/user`ã¯å®šç¾©ã—ã¦ã„ãªã„ãŸã‚404ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ãªã£ã¦ã„ã‚‹ã€‚

ã“ã®çŠ¶æ…‹ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## 404ã‚¨ãƒ©ãƒ¼å®Ÿè£…

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«å®Ÿè£…ã€‚
FastAPIã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒèª­ã¿ã‚„ã™ãã¦å¥½ãâ˜º
https://fastapi.tiangolo.com/tutorial/handling-errors/

å…¬å¼ã¯è‡ªä½œã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã€‚
ä»Šå›ã¯HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹`404`è‡ªä½“ã‚’æ‹¾ã„ãŸã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã¿ãŸã€‚

```python
import uvicorn
from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import JSONResponse

app = FastAPI()


@app.get("/hello")
def hello_world() -> dict[str, str]:
    return {"hello": "world"}


# 404ã‚¨ãƒ©ãƒ¼ã‚’æ‹¾ã†
@app.exception_handler(404)
def not_found(req: Request, exc: HTTPException) -> JSONResponse:
    return JSONResponse(content={"notFound": str(req.url)}, status_code=404)


def main() -> None:
    uvicorn.run("main:app", port=8000, host="0.0.0.0", reload=True)


if __name__ == "__main__":
    main()

```

`@app.exception_handler`ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ã€‚
å¼•æ•°ã¯ä»»æ„ã®ã‚¨ãƒ©ãƒ¼å‹ã‹intã‚’æŒ‡å®šã§ãã‚‹ã€‚
å…¬å¼ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‹ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãŒã€ä»Šå›ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®404ã‚’æŒ‡å®š
`fastapi.responses.JSONResponse`ã«contentã¨status_codeã‚’æŒ‡å®šã™ã‚‹ã€‚

å†åº¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã€‚

```bash
$ curl 127.0.0.1:8000/hello
{"hello":"world"}

$ curl 127.0.0.1:8000/user
{"notFound":"http://127.0.0.1:8000/user"}
```

`404`ã‚’æ‹¾ã£ã¦ãã‚Œã‚‹ã®ãŒç¢ºèªã§ããŸã€‚

### JSONResponse

#### content

JSONResponseã¯`contest`ã«æŒ‡å®šã—ãŸã‚‚ã®ã‚’jsonå½¢å¼ã«å¤‰æ›ã—ã¦ãã‚Œã‚‹ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã§ã¯`dict`ã‚’æŒ‡å®šã—ãŸãŒjsonå½¢å¼ã«ã§ãã‚‹ãªã‚‰ä½•ã§ã‚‚è‰¯ã„ã€‚

`list`ã¯æ­£å¸¸ã«è¿”å´ã—ã¦ãã‚Œã‚‹ã€‚

```python
# contentã¯å¤‰æ›ã§ãã‚Œã°ä½•ã§ã‚‚OK
@app.exception_handler(404)
def not_found(req: Request, exc: HTTPException) -> JSONResponse:
    return JSONResponse(content=["abc", "def"], status_code=404)
    
# $ curl 127.0.0.1:8000/user
# ["abc","def"]
```

ä½¿ã†æ©Ÿä¼šã¯é™ã‚‰ã‚Œãã†ã ãŒã€`str`ã ã‘ã‚‚å¤§ä¸ˆå¤«ã€‚

```python
# contentã¯å¤‰æ›ã§ãã‚Œã°ä½•ã§ã‚‚OK
@app.exception_handler(404)
def not_found(req: Request, exc: HTTPException) -> JSONResponse:
    return JSONResponse(content="sample", status_code=404)

# $ curl 127.0.0.1:8000/user
# "sample"
```

`pydantic.BaseModel`ã§ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã—ã¦ãŠãã“ã¨ã‚‚å¯èƒ½ã€‚
ãŸã ã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚’ãã®ã¾ã¾è¿”å´ã™ã‚‹ã“ã¨ã¯ã§ããªã„ç‚¹ã«æ³¨æ„ã€‚
äº‹å‰ã«`dict()`ãƒ¡ã‚½ãƒƒãƒ‰ã§å¤‰æ›ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```python:main.py
from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field

app = FastAPI()

# ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
class NotFound(BaseModel):
    msg: str = Field(...)

# NG
@app.exception_handler(404)
def not_found_ng(req: Request, exc: HTTPException) -> JSONResponse:
    return JSONResponse(content=NotFound(msg=str(req.url)), status_code=404)

# OK
@app.exception_handler(404)
def not_found_ok(req: Request, exc: HTTPException) -> JSONResponse:
    return JSONResponse(content=NotFound(msg=str(req.url)).dict(), status_code=404)

# $ curl 127.0.0.1:8000/user
# {"msg":"http://127.0.0.1:8000/user"}
```

:::message
2023å¹´6æœˆ(åŸ·ç­†æ™‚) pydanticã¯é–‹ç™ºv2ã¨ç¾è¡Œ1.10ãŒå­˜åœ¨ã—ã¾ã™ã€‚
pydantic 1.10ã¯`.dict`ã§ã™ãŒ
pydantic v2ã¯`.model_dump`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚‹ãŸã‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
:::

##### status_code

`status_code`ã«ã¯HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒ‡å®šã§ãã‚‹ã€‚

APIã§ã¯404ã‚¨ãƒ©ãƒ¼ã‚’æ‹¾ã†ãŒ
å®Ÿéš›ã«è¿”å´ã™ã‚‹ã¨ãã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯400ã§è¿”å´â€¦ã¿ãŸã„ãªã“ã¨ãŒå¯èƒ½ã€‚

```python
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´
@app.exception_handler(404)
def not_found(req: Request, exc: HTTPException) -> JSONResponse:
    return JSONResponse(content={"notFound": str(req.url)}, status_code=400)

```

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã•ã‚ŒãŸã‹ç¢ºèªã—ã¦ã¿ã‚‹ã€‚
`vscode`ã‚’ä½¿ã£ã¦ã„ã‚‹ãªã‚‰æ‹¡å¼µæ©Ÿèƒ½`REST Client`ã‚’å…¥ã‚Œã¦ãŠãã¨è‰¯ã„ã€‚
https://marketplace.visualstudio.com/items?itemName=humao.rest-client

æ‹¡å¼µå­`.http`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ›¸ã‘ã‚‹ã€‚

```http:test.http
GET http://localhost:8000/user
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ`400 Bad Request`ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã€‚
![ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡](https://storage.googleapis.com/zenn-user-upload/981ebe817232-20230624.png)

## ã¾ã¨ã‚

è¨˜äº‹ä¸­ã«ã‚‚ãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ã„ã‚‹ãŒFastAPIã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå„ªç§€ã§å¤§æŠµã®ã“ã¨ã¯æ›¸ã„ã¦ã‚ã‚‹ã€‚

ã‚ã‚‹ç‰¹å®šã®å‡¦ç†ã‚’æ›¸ããŸã„â€¦ã¿ãŸã„ãªã“ã¨ã§ãªã„é™ã‚Šã¯
æœ€åˆã«å…¬å¼ã‚’èª­ã‚“ã§ãŠãã¨è‰¯ã„ã¨æ€ã†ï¼

ä»¥ä¸Šã€ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼

## å‚è€ƒæ–‡çŒ®

- [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://fastapi.tiangolo.com/tutorial/handling-errors/)
