---
title: "gunicornã‚’systemdã§æ°¸ç¶šåŒ–ã—ã¦ã¿ã‚‹"
emoji: "ğŸ¦„"
type: "tech"
topics:
  - "python"
  - "fastapi"
  - "gunicorn"
published: true
published_at: "2023-07-24 07:25"
---

## FastAPIã‚’systemdã§åˆ¶å¾¡ã—ãŸã„

ç­†è€…ã¯FastAPIã‚’æ¥­å‹™ã§ä½¿ç”¨ã—
å®Ÿé‹ç”¨æ™‚ã¯gunicornã§ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚

ãŸã ã€æ¯åº¦ä½œæ¥­ã™ã‚‹ã¨ãã«gunicornã‚’ç›´æ¥ã‚­ãƒ«ã—ã¦ã„ã¦
ã„ã¤ã‹ãƒŸã‚¹ã—ãã†ãªæ°—ãŒã—ãŸã®ã§systemdã§å‹•ã‹ã—ãŸã„ãªã‚â€¦ã£ã¦æ€ã£ã¦ã„ã¾ã—ãŸã€‚

ä»Šå›ã¯æ¤œè¨¼ç’°å¢ƒã‚’ã‚µã‚¯ãƒƒã¨æº–å‚™ã—ã¦ã€systemdã«ã‚ˆã‚‹æ°¸ç¶šåŒ–ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚

## æ¤œè¨¼ç’°å¢ƒ

æ¤œè¨¼ç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Š

### ã‚µãƒ¼ãƒ

dockerã‚’ä½¿ç”¨ã€‚

ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯`redhat/ubi8`
Red Hatç¤¾æä¾›ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

https://access.redhat.com/ja/articles/5632841
https://hub.docker.com/r/redhat/ubi8

ã“ã‚Œã‚’systemdã§å‹•ã‹ã›ã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚

### python

dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«pythonå®Ÿè¡Œç’°å¢ƒã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚„ã‚Šæ–¹ã¯è‰²ã€…ã‚ã‚Šã¾ã™ãŒ
å€‹äººçš„æ¨ã—ã®`rye`ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

https://github.com/mitsuhiko/rye

## ç’°å¢ƒæº–å‚™

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`docker`+`rye`+`systemd`ã‚’ä½¿ã£ãŸå ´åˆã®æ§‹æˆä¾‹ã§ã™ã€‚

```bash
.
â”œâ”€â”€ docker # ç’°å¢ƒæ§‹ç¯‰ç”¨
â”‚   â”œâ”€â”€ compose.yaml
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ service 
â”‚   â””â”€â”€ fastapi-gunicorn.service # systemdã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ main.py # ã‚µãƒ¼ãƒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ pyproject.toml # rye
â””â”€â”€ .python-version # rye

```

ä»¥ä¸‹ã“ã®æ§‹æˆã§è©±ã‚’é€²ã‚ã¾ã™ã€‚

## å„ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

### docker

æ¤œè¨¼ç’°å¢ƒç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

#### compose.yaml

```yaml:compose.yaml

name: gunicorn-sample
services:
  app:
    build:
      context: ../
      dockerfile: ./docker/Dockerfile
    working_dir: "/usr/local/backend"
    ports:
      - "8000:8000"
    # systemdã‚’ä½¿ãˆã‚‹çŠ¶æ…‹ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚‹è¨­å®š
    tty: true
    privileged: true
    command: "/sbin/init"

```

`ports`ã¯FastAPIãŒèµ·å‹•ã™ã‚‹ãƒãƒ¼ãƒˆã‚’ä»»æ„ã®ãƒãƒ¼ãƒˆç•ªå·ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
`tty, privileged, command`ãŒsystemdã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«å¿…è¦ãªè¨­å®šã§ã™ã€‚

#### Dockerfile

```docker:Dockerfile
FROM redhat/ubi8:8.8-854

WORKDIR /usr/local/backend
COPY main.py pyproject.toml .python-version ./
COPY service/fastapi-gunicorn.service /etc/systemd/system/

RUN dnf update -y && dnf clean all

# psã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN dnf install -y procps && dnf clean all

# ryeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN curl -sSf https://rye-up.com/get | RYE_INSTALL_OPTION="--yes" bash
RUN echo 'source "$HOME/.rye/env"' >> ~/.bashrc

# æ“ä½œã—ã‚„ã™ã„ã‚ˆã†ã«ã‚¨ã‚¤ãƒªã‚¢ã‚¹è²¼ã£ã¦ãŠã
RUN echo 'alias ll="ls -l"' >> ~/.bashrc
RUN echo 'alias la="ls -la"' >> ~/.bashrc
```

`ps`ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ—ãƒ­ã‚»ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«å…¥ã‚Œã¾ã—ãŸã€‚

`rye`ã¯`RYE_INSTALL_OPTION="--yes"`ã‚’æŒ‡å®šã€‚
å¿œç­”ã‚’å…¨ã¦yesã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ãŠå¥½ã¿ã§ã©ã†ãã€‚

### rye

ryeã§å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
æ¤œè¨¼ã™ã‚‹ã ã‘ãªã®ã§äºˆã‚æº–å‚™ã—ã¦ãŠãã¾ã—ãŸã€‚

#### pyproject.toml

- `fastapi`
- `uvicorn[standard]`
- `gunicorn`

ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚
æ§‹ç¯‰æ™‚ç‚¹ã§ç„¡ãã¦ã‚‚ã€å¾Œã‹ã‚‰`rye add`ã§è¿½åŠ ã™ã‚Œã°ç‰¹ã«å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

```toml:pyproject.toml
[project]
name = "my_project"
version = "0.1.0"
description = "gunicorn sample"
authors = []
dependencies = [
    "fastapi>=0.100.0",
    "uvicorn[standard]>=0.23.1",
    "gunicorn>=21.2.0",
]
requires-python = ">= 3.8"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.rye]
managed = true
dev-dependencies = []

[tool.hatch.metadata]
allow-direct-references = true

```

#### .python-version

ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ¡ç”¨

```bash
cpython@3.11
```

### ã‚µãƒ¼ãƒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

#### main.py

`/hello`ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨
`{"hello": "world!!"}`ãŒè¿”ã£ã¦ãã¾ã™ã€‚

```python:main.py
from fastapi import FastAPI

app = FastAPI()


@app.get("/hello")
def get_hello_world() -> dict[str, str]:
    return {"hello": "world!!"}

```

### ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«

ä»Šå›ã®ä¸»å½¹ã€‚
systemdã§ä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```systemd:fastapi-gunicorn.service

[Unit]
Description=Gunicorn Sample App
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=/usr/local/backend
ExecStart=/usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
Restart=always
PIDFile=/usr/local/backend/master.pid

[Install]
WantedBy=multi-user.target

```

`User, Group`ã¯dockerã®ãŸã‚rootã«ã—ã¦ã„ã¾ã™ã€‚

`ExecStart`ã«gunicornã®èµ·å‹•ã‚’æŒ‡å®šã€‚
`{dir}/.venv/bin/python -m gunicorn`ã§
ä»®æƒ³ç’°å¢ƒå†…ã®gunicornã‚’èµ·å‹•ã•ã›ã¾ã™ã€‚

`-p {pid_file}`ã§ãƒ—ãƒ­ã‚»ã‚¹IDãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆç«‹ã¡ä¸Šã’æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹ï¼‰
ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`PIDFile`ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã§æº–å‚™å®Œäº†ã§ã™ã€‚

## æ°¸ç¶šåŒ–æ¤œè¨¼é–‹å§‹

### dockerèµ·å‹•

dockerã‚’èµ·å‹•ã—ã¾ã™

```bash
cd docker
docker compose up -d
```

èµ·å‹•ã—ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã£ãŸã‹ç¢ºèª

```bash
docker ps

# CONTAINER ID   IMAGE                 COMMAND        CREATED         STATUS        PORTS                                       NAMES
# {id}           gunicorn-sample-app   "/sbin/init"   2 seconds ago   Up 1 second   0.0.0.0:8000->8000/tcp, :::8000->8000/tcp   gunicorn-sample-app-1
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–

dockerãŒèµ·å‹•ã—ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚

```bash
docker exec -it gunicorn-sample-app-1  /bin/bash
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ã‚’è¡Œã„ã¾ã™

```bash
pwd
# /usr/local/backend

ls -la
# -rw-r--r-- 1 root root   13 Jul 21 04:39 .python-version
# -rw-r--r-- 1 root root  136 Jul 21 06:44 main.py
# -rw-r--r-- 1 root root 1530 Jul 21 04:44 pyproject.toml

rye sync

ls -la
# -rw-r--r-- 1 root root   13 Jul 21 04:39 .python-version
# drwxr-xr-x 4 root root 4096 Jul 21 08:52 .venv
# -rw-r--r-- 1 root root  136 Jul 21 06:44 main.py
# -rw-r--r-- 1 root root 1530 Jul 21 04:44 pyproject.toml
# -rw-r--r-- 1 root root  731 Jul 21 08:52 requirements-dev.lock
# -rw-r--r-- 1 root root  520 Jul 21 08:52 requirements.lock

```

`.venv`ã‚„ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºæ¥ã¦ã„ãŸã‚‰OKã§ã™ã€‚

### systemdèµ·å‹•

systemdã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã•ã›ã¾ã™ã€‚

```bash
systemctl daemon-reload

# é©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹
systemctl status fastapi-gunicorn.service
# â— fastapi-gunicorn.service - Gunicorn Sample App
#    Loaded: loaded (/etc/systemd/system/fastapi-gunicorn.service; disabled; vendor preset: disabled)
#    Active: inactive (dead)

# è‡ªå‹•èµ·å‹•
systemctl enable fastapi-gunicorn.service
# Created symlink /etc/systemd/system/multi-user.target.wants/fastapi-gunicorn.service â†’ /etc/systemd/system/fastapi-gunicorn.service.

# gunicornã®ãƒ—ãƒ­ã‚»ã‚¹ãŒã¾ã èµ·å‹•ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
ps aux | grep gunicorn | grep -v grep

# ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
systemctl start fastapi-gunicorn.service

# gunicornã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã§ãã‚‹
ps aux | grep gunicorn | grep -v grep
# root         141 12.5  0.5  63608 31044 ?        Ss   09:00   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         142  169  0.8 1127876 48644 ?       R    09:00   0:01 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         143  164  0.7 1127184 47984 ?       R    09:00   0:01 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         144  155  0.7 1127184 47992 ?       R    09:00   0:01 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         145  146  0.7 1126168 44880 ?       R    09:00   0:01 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹
curl http://localhost:8000/hello
{"hello":"world!!"}

```

ã“ã‚Œã§OKã§ã™ã€‚

## æ¤œè¨¼

systemdã§gunicornã‚’ç«‹ã¡ä¸Šã’ãŸã“ã¨ã§è‰²ã€…å‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

### èµ·å‹•ãƒ»åœæ­¢ãƒ»å†èµ·å‹•

systemdã§ç«‹ã¡ä¸Šã’ãŸã®ã§`systemctl`ã‚³ãƒãƒ³ãƒ‰ã§ä¸€é€£ã®å‹•ä½œãŒå¯èƒ½ã§ã™ã€‚

```bash

# ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
systemctl stop fastapi-gunicorn

# ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
systemctl start fastapi-gunicorn

# ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•
systemctl restart fastapi-gunicorn

# è¨­å®šæ›´æ–°(gunicornã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆæœ‰åŠ¹)
systemctl reload fastapi-gunicorn

```

### ãƒ—ãƒ­ã‚»ã‚¹ã‚­ãƒ«æ¤œçŸ¥

æœ€ã‚‚ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨ã§ã™ã€‚
ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‚’`master.pid`ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚­ãƒ«ã•ã‚Œã¦ã‚‚ã€systemdå´ã§æ¤œçŸ¥ã—è‡ªå‹•èµ·å‹•ã—ã¾ã™ã€‚

```bash
# ä»Šã®çŠ¶æ…‹ã‚’ç¢ºèª
ps aux | grep gunicorn | grep -v grep
#root         149  0.9  0.3  62240 29768 ?        Ss   00:08   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
#root         150  5.5  0.6 1130072 54932 ?       S    00:08   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
#root         151  5.2  0.6 1130072 54948 ?       S    00:08   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
#root         152  5.7  0.6 1130080 54940 ?       S    00:08   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
#root         153  5.8  0.6 1130080 54924 ?       S    00:08   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker

# ç¾åœ¨ã®ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹
cat master.pid 
# 149

# ãƒ—ãƒ­ã‚»ã‚¹ã‚­ãƒ«
kill `cat master.pid`

# å†åº¦ç¢ºèª
cat master.pid 
# 161
# ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ãŒå¤‰ã‚ã£ã¦ã„ã‚‹

# è‡ªå‹•ã§å¾©å¸°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹
ps aux | grep gunicorn | grep -v grep
# root         161  2.3  0.3  62240 29732 ?        Ss   00:10   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         162 10.6  0.6 1130068 55056 ?       S    00:10   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         163 11.3  0.6 1130068 55072 ?       S    00:10   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         164 13.4  0.6 1130076 55064 ?       S    00:10   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker
# root         165 13.0  0.6 1130076 55048 ?       S    00:10   0:00 /usr/local/backend/.venv/bin/python -m gunicorn main:app -p /usr/local/backend/master.pid -w 4 -k uvicorn.workers.UvicornWorker

```

ã“ã‚Œã§ã€gunicornã‚’å®‰å…¨ã«æ“ä½œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
