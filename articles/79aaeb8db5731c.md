---
title: "Ruff + pre-commitã§ã‚³ãƒŸãƒƒãƒˆæ™‚ã«ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ä¿ã¡ãŸã„"
emoji: "ğŸª"
type: "tech"
topics:
  - "git"
  - "python"
  - "mypy"
  - "precommit"
  - "ruff"
published: true
published_at: "2023-11-19 11:30"
---

## ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’ä¿ã¡ãŸã„

æœ€è¿‘ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æ™‚ã«ã“ã‚“ãªæ‚©ã¿ãŒã‚ã‚Šã¾ã—ãŸã€‚

- æˆ»ã‚Šå€¤ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¼ã‚Œã¦ã„ã‚‹ãªâ€¦
- docStringæ›¸ãå¿˜ã‚Œã¦ã„ã‚‹â€¦
- ã‚ã‚Œï¼Ÿãã‚‚ãã‚‚ã“ã‚Œæ›¸ã„ãŸäººã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ãƒ»ãƒªãƒ³ã‚¿ãƒ¼åŠ¹ã„ã¦ã„ãªã„ã‹ã‚‚â€¦ï¼Ÿ

å€‹äººçš„ãªæ„è¦‹ã¨ã—ã¦
ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã¯ãƒªãƒ³ã‚¿ãƒ¼ã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’æ­£å¸¸ã«é€šéã—ãŸã‚‚ã®ã§ã‚ã£ã¦ã»ã—ã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

æ­£å¸¸ã«é€šéã—ãŸã‚‚ã®ã§ã‚ã‚Œã°ã€æœ¬æ¥ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç›®çš„ã§ã‚ã‚‹
ã‚³ãƒ¼ãƒ‰ã®æ›¸ãã£ã·ã‚Šã«æ³¨åŠ›ã§ãã‚‹ã¨æ€ã„ã¾ã—ãŸã€‚

è‰²ã€…èª¿ã¹ãŸçµæœã€`pre-commit`ã‚’ä½¿ãˆã°è§£æ±ºã§ããã†ã ã¨ã‚ã‹ã£ãŸã®ã§
æ¤œè¨¼å«ã‚ã¦è¨˜äº‹ã«æ®‹ã—ã¾ã™ã€‚

## ä½¿ç”¨æŠ€è¡“

pre-commitã¯
ã‚³ãƒ¼ãƒ‰ãŒãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã‚‹å‰ã«ç‰¹å®šã®ãƒã‚§ãƒƒã‚¯ã‚„ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹å„ªã‚Œã‚‚ã®ã§ã™ã€‚
https://pre-commit.com/

ã“ã‚Œã‚’ä½¿ç”¨ã—ã€ã‚³ãƒŸãƒƒãƒˆæ™‚ã«ãƒªãƒ³ã‚¿ãƒ¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’ã‹ã‘
ãƒŸã‚¹ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆå‡ºæ¥ãªã„ä»•çµ„ã¿ã«ã—ã¾ã™ã€‚

Pythonã®ãƒªãƒ³ã‚¿ãƒ¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã¯è‰²ã€…ã‚ã‚Šã¾ã™ãŒ
ä»Šå›ã¯`Ruff`ã¨`mypy`ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

- [Ruff](https://docs.astral.sh/ruff/)
- [mypy](https://mypy.readthedocs.io/en/stable/#)

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### pre-commit

pipã‹brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install pre-commit

# ã‚‚ã—ãã¯
brew install pre-commit
```

### Ruff

pipã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install ruff
```

### mypy

pipã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install mypy
```

## Tips. VsCodeã§é–‹ç™ºã—ã¦ã„ã‚‹ãªã‚‰â€¦

VsCodeã§é–‹ç™ºã—ã¦ã„ã‚‹å ´åˆã€Ruffã¨mypyã¯æ‹¡å¼µæ©Ÿèƒ½ã§å¯¾å¿œå‡ºæ¥ã¾ã™ã€‚

| Name    | ID                            | URL                            |
| ------- | ----------------------------- |--------------------------------|
| Ruff    | `charliermarsh.ruff`          | https://marketplace.visualstudio.com/items?itemName=charliermarsh.ruff |
| Mypy    | `ms-python.mypy-type-checker` | https://marketplace.visualstudio.com/items?itemName=ms-python.mypy-type-checker |

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã‚³ãƒŸãƒƒãƒˆæ™‚ã®æ¤œè¨¼ãŒã§ãã‚‹ã‚ˆã†ã«
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¾ã™ã€‚

æº–å‚™ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®é€šã‚Š

| ãƒ•ã‚¡ã‚¤ãƒ«å                  | èª¬æ˜                            |
| ---------------------------| ----------------------------- |
| .pre-commit-config.yaml    | pre-commitã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€‚ã‚³ãƒŸãƒƒãƒˆæ™‚ã®æ¤œè¨¼æ–¹æ³•ã‚’è¨˜è¿°ã€‚          |
| pyproject.toml             | `Ruff`,`mypy`ã®è¨­å®šã‚’è¨˜è¿°ã€‚ã‚³ãƒŸãƒƒãƒˆæ¤œè¨¼æ™‚ã¯ã“ã®è¨­å®šã‚’é€šã—ã¦ç¢ºèªãŒè¡Œã‚ã‚Œã¾ã™ã€‚ |
| .vscode/settings.json      | `Ruff`,`mypy`ã®è¨­å®šã‚’è¨˜è¿°ã€‚ï¼ˆVsCodeä½¿ç”¨ã™ã‚‹å ´åˆï¼‰ |

ã“ã‚Œã‚‰ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆé…ä¸‹ã«é…ç½®ã—ã¾ã™ã€‚

```bash
.
â”œâ”€â”€ .pre-commit-config.yaml
â”œâ”€â”€ pyproject.toml
â””â”€â”€ .vscode
    â””â”€â”€ settings.json
```

### .pre-commit-config.yaml

ã‚³ãƒŸãƒƒãƒˆæ™‚ã®æ¤œè¨¼å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
å„ã‚­ãƒ¼ã®æ„å‘³ã¯[ã“ã¡ã‚‰](https://pre-commit.com/#usage)ã‚’å‚ç…§

```yaml

repos:
# Ruff
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.6
    hooks:
      # Run the linter.
      - id: ruff
        name: ruff
        description: "Run 'ruff' for extremely fast Python linting"
        entry: ruff check --force-exclude
        language: python
        types_or: [python, pyi]
        # --fix: enable lint fixes
        args: [--fix]
        require_serial: true
        additional_dependencies: []
        minimum_pre_commit_version: "2.9.2"
      # Run the formatter.
      - id: ruff-format
        name: ruff-format
        description: "Run 'ruff format' for extremely fast Python formatting"
        entry: ruff format --force-exclude
        language: python
        types_or: [python, pyi]
        args: []
        require_serial: true
        additional_dependencies: []
        minimum_pre_commit_version: "2.9.2"
# mypy
  -   repo: https://github.com/pre-commit/mirrors-mypy
      rev: v1.7.0
      hooks:
      # Run the mypy.
      - id: mypy
        name: mypy
        description: "Run 'mypy' for Python linting"
        entry: mypy
        language: python
        args: [--strict, --ignore-missing-imports]
        require_serial: true
        # Add types package list
        additional_dependencies: []
        minimum_pre_commit_version: '2.9.2'

```

Ruffã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã¯`v0.1.2`ã§ä»¥é™ã§ã—ã‹å‹•ã‹ãªã„ã®ã§
ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã«ã”æ³¨æ„ãã ã•ã„ã€‚

### pyproject.toml

Ruffãƒ»mypyã®å…·ä½“çš„ãªè¨­å®šã‚’è¨˜è¿°ã—ã¾ã™ã€‚
ä¸‹è¨˜ã¯ç§ã®ç’°å¢ƒã®è¨­å®šä¾‹ã§ã™ã€‚

```toml
[tool.mypy]
strict = true
ignore_missing_imports = true

[tool.ruff]
select = [
    "F", # pyflakes
    "E", # pycodestyle
    "W", # pycodestyle warnings
    "I", # isort
    "D", # pydocstyle
]
ignore = []
# 1è¡Œã®æœ€å¤§æ–‡å­—æ•°
line-length = 88

extend-ignore = [
    "D105", # undocumented-magic-method
    "D107", # undocumented-public-init
    "D205", # blank-line-after-summary
    "D415" # ends-in-punctuation
]

[tool.ruff.lint.pydocstyle]
# docstringã¯google style
convention = "google"

[tool.ruff.per-file-ignores]
# å€‹åˆ¥è¨­å®š
# __init__.pyã¯æœªä½¿ç”¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¨±å®¹
"__init__.py" = ["F401"]

```

å„è¨­å®šã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã™ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™

â–  Ruff

- [Linterã®èª¬æ˜](https://docs.astral.sh/ruff/linter/#ruff-check)
- [Formatterã®èª¬æ˜](https://docs.astral.sh/ruff/formatter/)
- [å„ãƒ«ãƒ¼ãƒ«ã®èª¬æ˜](https://docs.astral.sh/ruff/rules/)

â–  mypy

mypyã¯è¨­å®šé …ç›®ãŒå¤šã„ã®ã§ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰é€†å¼•ãã§è¦‹ã‚‹ã®ãŒè‰¯ã„ã‹ã‚‚

- [command line](https://mypy.readthedocs.io/en/stable/command_line.html)

### .vscode/settings.json

vscodeã®è¨­å®šã§ã™ã€‚

```json
{
  // ãƒ«ãƒ¼ãƒ©ãƒ¼ (å‚è€ƒ)
  "editor.rulers": [80, 88],

  "[python]": {
    "editor.codeActionsOnSave": {
      // isortã®ä¸¦ã³æ›¿ãˆã‚’Ruffã§å®Ÿè¡Œ
      "source.organizeImports": true
    },
    "editor.defaultFormatter": "charliermarsh.ruff",
    "editor.formatOnSave": true
  },
  // pipã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå ´åˆã¯ä¸‹è¨˜ã‚’é …ç›®æŒ‡å®šã€‚
  // "ruff.path": ["${workspaceFolder}/.venv/bin/ruff"],
  // "mypy-type-checker.path": ["${workspaceFolder}/.venv/bin/mypy"]
}

```

## pre-commitã‚’ä½¿ã†ãŸã‚ã«

pre-commitã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ãŸã ã‘ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚
ã‚³ãƒŸãƒƒãƒˆæ™‚ã«æ¤œè¨¼ã•ã›ã‚‹ã«ã¯ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
pre-commit install
# pre-commit installed at .git/hooks/pre-commit
```

ã“ã‚Œã§OKã§ã™ã€‚

## æ¤œè¨¼

ã§ã¯æ—©é€Ÿæ¤œè¨¼ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä¸€ä¾‹ã¨ã—ã¦ã€Ruffã®ãƒªãƒ³ã‚¿ãƒ¼ã®æ©Ÿèƒ½ç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚
ä»¥ä¸‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æº–å‚™ã—ã¾ã™ã€‚

```python
"""ã‚µãƒ³ãƒ—ãƒ«"""
import os
from datetime import datetime

print(datetime.now())
```

ä¸Šè¨˜ã®å ´åˆã€`import os`ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã®ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã¿ã¾ã™

```bash
git add main.py

git commit -m "add: main.py"
[INFO] Stashing unstaged files to ${HOME}/.cache/pre-commit/patch1700351265-106434.
ruff.....................................................................Failed
- hook id: ruff
- files were modified by this hook

Found 1 error (1 fixed, 0 remaining).

ruff-format..............................................................Passed
mypy.....................................................................Passed
[INFO] Restored changes from ${HOME}/.cache/pre-commit/patch1700351265-106434.
```

ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚³ãƒŸãƒƒãƒˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

Ruffã¯ãƒªãƒ³ã‚¿ãƒ¼å¼•æ•°ã«`--fix`ã‚’è¿½åŠ ã™ã‚‹ã¨ã€æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã«å‡ºæ¥ãã†ã¨ãã¯
ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚

`.pre-commit-config.yaml`ä¸‹è¨˜éƒ¨åˆ†ã§ã™ã€‚

```yaml
- id: ruff
    # ä»–ã®é …ç›®...
    # --fix: enable lint fixes
    args: [--fix]
```

```bash
diff --git a/main.py b/main.py
index 7f26ecb..b548b8c 100644
--- a/main.py
+++ b/main.py
@@ -1,5 +1,4 @@
 """Top"""
-import os
 from datetime import datetime
 
 print(datetime.now())
```

å…ˆç¨‹ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã‚ã’ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒªãƒ³ã‚¿ãƒ¼ã‚’é€šã—ã¦å‡ºã¦ããŸãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ãŒç¢ºèªå‡ºæ¥ã¾ã—ãŸã€‚
å·®åˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã—ã¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ã¿ã¾ã™ã€‚

```bash
git add main.py
git commit -m "add: main.py"
[INFO] Stashing unstaged files to ${HOME}/.cache/pre-commit/patch1700351634-107442.
ruff.....................................................................Passed
ruff-format..............................................................Passed
mypy.....................................................................Passed
[INFO] Restored changes from ${HOME}/.cache/pre-commit/patch1700351634-107442.
[main 63cab02] add: main.py
 1 file changed, 4 insertions(+
```

ãƒªãƒ³ã‚¿ãƒ¼ã‚’ç„¡äº‹ãƒ‘ã‚¹ã—ã€ã‚³ãƒŸãƒƒãƒˆã«æˆåŠŸã€‚
`main.py`ã¯ã‚³ãƒ¼ãƒ‰å“è³ªãŒä¿ãŸã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸã€‚

## äººåŠ›ã§ã¯ãªãã‚·ã‚¹ãƒ†ãƒ å´ã‹ã‚‰ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ä¿ãŸã›ã‚ˆã†

`pre-commit`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒŸãƒƒãƒˆæ™‚ã«ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ä¿ã¤æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ã‚­ãƒ¬ã‚¤ã«ä¿ã¦ãã†ã§ã€é–‹ç™ºãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ãŒã‚Šãã†ã§ã™ã€‚

ç´¹ä»‹ã—ãŸãƒªãƒ³ã‚¿ãƒ¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã®ä»–ã«
ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯ã‚‚ã‚ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã—ãŸã€‚

å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

## å‚è€ƒã‚µã‚¤ãƒˆä¸€è¦§

- [pre-commit](https://pre-commit.com/)
- [Ruff](https://docs.astral.sh/ruff/)
- [mypy](https://mypy.readthedocs.io/en/stable/#)
- [Ruff pre-commit github](https://github.com/astral-sh/ruff-pre-commit)
- [mypy pre-commit github](https://github.com/pre-commit/mirrors-mypy)
- [ã€Gitã€‘ã‚³ãƒŸãƒƒãƒˆç›´å‰ã«è‡ªå‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢ã™ã‚‹ã€Œpre-commitã€ãŒä¾¿åˆ©ã™ããŸã®ã§ç´¹ä»‹ã—ãŸã„](https://dev.classmethod.jp/articles/introduce-pre-commit/)
