---
title: "Plotlyã§å‡ºåŠ›ã—ãŸSVGã®èª­ã¿æ›¸ãã‚’ã™ã‚‹Tips"
emoji: "ğŸ¯"
type: "tech"
topics:
  - "python"
  - "plotly"
  - "svg"
  - "xml"
published: true
published_at: "2023-08-10 08:40"
---

## SVG å‡ºåŠ›ã—ãŸã‚°ãƒ©ãƒ•ã‹ã‚‰å‡¡ä¾‹ã‚’åˆ‡ã‚Šå–ã‚ŠãŸã„â€¦

[å‰å›ã®è¨˜äº‹](https://zenn.dev/nowa0402/articles/5eeb1366286856)ã§ãƒ‡ãƒ¼ã‚¿å€‹æ•°ã«ã‚ˆã‚‹ã‚°ãƒ©ãƒ•ã®é•ã„ã‚’è§£èª¬ã—ã¾ã—ãŸã€‚
ä»Šå›ã¯SVGå‡ºåŠ›ã•ã‚ŒãŸç”»åƒã‹ã‚‰å‡¡ä¾‹ã¨ã‚°ãƒ©ãƒ•ã‚’åˆ†ã‘ã‚‹Tipsã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

SVGã®æ“ä½œã¯Pythonæ¨™æº–æ­è¼‰ã®xmlãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚
https://docs.python.org/ja/3/library/xml.etree.elementtree.html

## å‰æ®µ: å‰å›å‡ºåŠ›ã—ãŸã‚°ãƒ©ãƒ•

ä»Šå›ã¯ä»¥ä¸‹ã‚³ãƒ¼ãƒ‰ï¼ˆå‰å›è¨˜äº‹ï¼‰ã§å‡ºåŠ›ã—ãŸç”»åƒã‚’åŸºã«åˆ†å‰²ä½œæ¥­ã‚’è¡Œã„ã¾ã™ã€‚

```python
import numpy as np
import plotly.graph_objects as go
import plotly.io as pio

N = 20
random_x = np.linspace(0, 1, N)
random_y0 = np.random.randn(N) + 5
random_y1 = np.random.randn(N)

plot = [
    go.Scatter(
        mode="lines+markers",
        x=random_x,
        y=random_y0,
        name="sampleA",
        line=dict(color="blue", dash="solid"),
        marker=dict(symbol="circle-open"),
    ),
    go.Scatter(
        mode="lines+markers",
        x=random_x,
        y=random_y1,
        name="sampleB",
        line=dict(color="red", dash="solid"),
        marker=dict(symbol="circle-open"),
    ),
]

fig = go.Figure(data=plot)

# SVGå‡ºåŠ›
pio.write_image(fig, "./output.svg", format="svg")
```

å‡ºåŠ›ã•ã‚ŒãŸç”»åƒã¯ã“ã¡ã‚‰
![ã‚°ãƒ©ãƒ•ç”»åƒ](https://storage.googleapis.com/zenn-user-upload/c3d953531d2c-20230810.png =500x)

ã“ã®ç”»åƒã‹ã‚‰å‡¡ä¾‹ã¨ã‚°ãƒ©ãƒ•ã‚’åˆ¥ã€…ã«å‡ºåŠ›ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ç”»åƒã®æ§‹æˆè¦ç´ ã‚’ç¢ºèªã™ã‚‹

ç”»åƒã®è¦ç´ ã‚’ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã§è§£æã—ã¾ã™ã€‚

![ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ç”»åƒ](https://storage.googleapis.com/zenn-user-upload/c51aad221c01-20230810.png)

å‡¡ä¾‹ã®ã¨ã“ã‚ã ã‘åˆ‡ã‚ŠæŠœãã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```html
<svg>
  <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ± -->
  <g class="infolayer">
    <!-- å‡¡ä¾‹é–¢ä¿‚ -->
    <g class="legend">
      <rect class="bg"></rect>
      <g class="scrollbox">
        <g class="groups">
          <!-- ã“ã“ã«å‡¡ä¾‹ã®å„è¦ç´ ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ -->
          <g class="traces"></g>
          <g class="traces"></g>
        </g>
      </g>
      <rect class="scrollbar"></rect>
    </g>
  </g>
</svg>
```

`infolayerâ†’legend` ã®é †ã§æ˜ã£ã¦ã„ã‘ã‚Œã°ç›®çš„ã®å‡¡ä¾‹ã«è¾¿ã‚Šç€ã‘ãã†ã§ã™ã€‚

## å‡¡ä¾‹å‡ºåŠ›ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æº–å‚™ã™ã‚‹

å‡¡ä¾‹ã®ä½ç½®ã¯ç”»åƒã‹ã‚‰ã®çµ¶å¯¾å€¤ã§æ±ºã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

`<g class="legend" ... transform="translate(*,*)">`ã® translate ã¯ä¸è¦ã®ãŸã‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æº–å‚™ã—ã€ãã“ã«å–å¾—ã—ãŸè¦ç´ ã‚’æŒ¿å…¥ã™ã‚‹å½¢ã«ã—ã¾ã—ãŸã€‚

ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã“ã¡ã‚‰ã§ã™ã€‚
`width, height`ã¯ç’°å¢ƒã«åˆã‚ã›ã¦é©å®œä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

```html
<svg
  class="main-svg"
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  width="700"
  height="500"
  style=""
  viewBox="0 0 700 500"
>
  <g class="infolayer">
    <g class="legend" pointer-events="all"></g>
  </g>
</svg>
```

## SVGã‚’XMLã¨ã—ã¦èª­ã¿å–ã‚‹

SVGã‚’XMLã¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚
ç”»åƒã¯ä¸Šã§ç´¹ä»‹ã—ãŸ`./output.svg`ã§ã™ã€‚

```python
import xml.etree.ElementTree as ET
from pathlib import Path

input_path = Path("./output.svg")

# èª­è¾¼
tree = ET.parse(input_path)

# è¦ç´ ã‚’å–å¾—
root = tree.getroot()

print(root)
# <Element '{http://www.w3.org/2000/svg}svg' at *********>

```

`root`ãŒè¦ç´ ã®ãƒ«ãƒ¼ãƒˆã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã‹ã‚‰æ¤œç´¢ã—ã¦ç›®çš„ã®å‡¡ä¾‹ã‚’å–å¾—ã—ã¾ã™ã€‚

## å‡¡ä¾‹ã‚’å–å¾—ã™ã‚‹

å‡¡ä¾‹ã®è¦ç´ ã‚’å–å¾—ã—ã¾ã™ã€‚
gã‚¿ã‚°ã¯`{http://www.w3.org/2000/svg}g`ã§è¦ç´ æ¤œç´¢ãŒå¯èƒ½ã§ã™ã€‚

`SVGèª­è¾¼â†’ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ¤œç´¢â†’å‡¡ä¾‹æ¤œç´¢â†’è¦ç´ å–å¾—`
ã®é †ç•ªã§ã™ã€‚

```python
import xml.etree.ElementTree as ET
from pathlib import Path

# xmlã§èª­ã¿è¾¼ã‚“ã gã‚¿ã‚°
SVG_G_TAG = "{http://www.w3.org/2000/svg}g"

input_path = Path("./output.svg")

tree = ET.parse(input_path)
root = tree.getroot()

# å¤§å…ƒgã‚¿ã‚°ã‹ã‚‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±å–å¾—
g_elems = root.findall(SVG_G_TAG)
info_elems = next(filter(lambda x: x.attrib["class"] == "infolayer", g_elems))

# ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã‹ã‚‰å‡¡ä¾‹å–å¾—
layer_elems = info_elems.findall(SVG_G_TAG)
legend_elems = next(filter(lambda x: x.attrib["class"] == "legend", layer_elems))

```

findall()ã§gã‚¿ã‚°ã‚’å…¨ã¦å–å¾—ã—ã¾ã™ã€‚
ãã®å¾Œã€`next*filter`ã‚’ä½¿ç”¨ã—gã‚¿ã‚°ã®ä¸­ã‹ã‚‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã¨å‡¡ä¾‹ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹åã§æ¤œç´¢ã—ã€è¦ç´ ã‚’ç‰¹å®šã—ã¾ã™ã€‚

ã“ã‚Œã§`<g class="legend">...</g>`ãŒå–å¾—ã§ãã¾ã—ãŸã€‚

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹

å–å¾—ã§ããŸè¦ç´ ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚

ã¾ãšã¯èª­ã¿è¾¼ã¿ã¨å‡¡ä¾‹ã®ç®‡æ‰€ã¾ã§æ¤œç´¢ã—ã¾ã™ã€‚

```python
import xml.etree.ElementTree as ET
from pathlib import Path

template_path = Path("./legend_template.svg")
template_tree = ET.parse(template_path)
template_root = template_tree.getroot()

# å‡¡ä¾‹ã®ã‚¿ã‚°ã‚’å–å¾—
template_legend = template_root.find(f"{SVG_G_TAG}/{SVG_G_TAG}")
if template_legend is None:
    raise

```

findãƒ¡ã‚½ãƒƒãƒ‰ã¯æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¦ç´ ã‚’å–å¾—ã—ã¾ã™ã€‚
çµæœã¯`Optional`ãªã®ã§ã€ä¸€åº¦Noneåˆ¤å®šã‚’å…¥ã‚Œã¦å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®šã•ã›ã¾ã™ã€‚

ãã®å¾Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‡¡ä¾‹ã«å¯¾ã—ã¦è¦ç´ ã‚’è¿½åŠ ã—ã¾ã™ã€‚
è¿½åŠ ã™ã‚‹ã«ã¯appendãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å‡¡ä¾‹ã‚’è¿½åŠ 
[template_legend.append(elem) for elem in legend_elems]

```

`legend_elems`ãŒå…ƒç”»åƒã‹ã‚‰å–å¾—ã—ãŸå‡¡ä¾‹è¦ç´ ã§ã™ã€‚
ãƒªã‚¹ãƒˆã®å†…åŒ…è¡¨è¨˜ã§å‡¡ä¾‹ä»¥ä¸‹ã®ã‚¿ã‚°ã‚’å…¨ã¦è¿½åŠ ã—ã¾ã™ã€‚

## å‡¡ä¾‹ç”»åƒå‡ºåŠ›

å‡¡ä¾‹ç”»åƒã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
ã—ã‹ã—ã€ãã®ã¾ã¾å‡ºåŠ›ã™ã‚‹ã¨`ns:0`ã¨ã„ã†`Namespace`ãŒè¿½åŠ ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€[ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/soh92/articles/f20994e755974f)ã‚’å‚è€ƒã«`ns:0`ã‚’è¿½åŠ ã—ãªã„ã‚ˆã†ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚

https://zenn.dev/soh92/articles/f20994e755974f

```python

# çµæœåæ˜ 
template_tree = ET.ElementTree(template_root)

# ns:0å¯¾ç­–
namespaces = {
    node[0]: node[1] for _, node in ET.iterparse(template_path, events=["start-ns"])
}
for key, value in namespaces.items():
    ET.register_namespace(key, value)

# å‡¡ä¾‹å‡ºåŠ›
legend_output_path = Path("./legend.svg")
template_tree.write(legend_output_path)

```

å‡ºåŠ›ã•ã‚ŒãŸç”»åƒã‚’ç¢ºèªã—ã¾ã™ã€‚

![å‡¡ä¾‹åˆ‡ã‚ŠæŠœã](https://storage.googleapis.com/zenn-user-upload/5fe3b4ea99e8-20230810.png)

å‡¡ä¾‹ã ã‘åˆ‡ã‚ŠæŠœãã“ã¨ã«æˆåŠŸã—ã¾ã—ãŸã€‚

## å…ƒç”»åƒã‹ã‚‰å‡¡ä¾‹ã‚’å‰Šé™¤

å…ƒç”»åƒã‹ã‚‰å‡¡ä¾‹éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚
è¦ç´ ã®å‰Šé™¤ã«ã¯removeãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
# å‡¡ä¾‹éƒ¨åˆ†å‰Šé™¤
info_elems.remove(legend_elems)

# å¤‰æ›´åæ˜ 
tree = ET.ElementTree(root)

# xmlã‚¿ã‚°å¯¾ç­–
target_namespaces = {
    node[0]: node[1] for _, node in ET.iterparse(input_path, events=["start-ns"])
}
for key, value in target_namespaces.items():
    ET.register_namespace(key, value)

# å‡¡ä¾‹ã‚’åˆ‡ã‚Šå–ã£ãŸã‚°ãƒ©ãƒ•å‡ºåŠ›
graph_output_path = Path("./graph.svg")
tree.write(graph_output_path)
```

ã‚°ãƒ©ãƒ•ã®ç”»åƒã‚’ç¢ºèªã—ã¾ã™ã€‚

![ã‚°ãƒ©ãƒ•ã®ç”»åƒ](https://storage.googleapis.com/zenn-user-upload/fdf04b07ccdd-20230810.png)

å‡¡ä¾‹ãŒåˆ‡ã‚Šå–ã‚‰ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã—ãŸï¼

## å®Ÿè£…ã‚³ãƒ¼ãƒ‰

ä¸Šè¨˜ã®å‡¦ç†ã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```python
import xml.etree.ElementTree as ET
from pathlib import Path

# xmlã§èª­ã¿è¾¼ã‚“ã gã‚¿ã‚°
SVG_G_TAG = "{http://www.w3.org/2000/svg}g"

input_path = Path("./output.svg")
template_path = Path("./legend_template.svg")

tree = ET.parse(input_path)
root = tree.getroot()

# å¤§å…ƒgã‚¿ã‚°ã‹ã‚‰æƒ…å ±ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
g_elems = root.findall(SVG_G_TAG)
info_elems = next(filter(lambda x: x.attrib["class"] == "infolayer", g_elems))

# æƒ…å ±ä¸€è¦§ã‹ã‚‰å‡¡ä¾‹å–å¾—
layer_elems = info_elems.findall(SVG_G_TAG)
legend_elems = next(filter(lambda x: x.attrib["class"] == "legend", layer_elems))

template_tree = ET.parse(template_path)
template_root = template_tree.getroot()

# å‡¡ä¾‹ã®ã‚¿ã‚°ã‚’å–å¾—
template_legend = template_root.find(f"{SVG_G_TAG}/{SVG_G_TAG}")
if template_legend is None:
    raise

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å‡¡ä¾‹ã‚’è¿½åŠ 
[template_legend.append(elem) for elem in legend_elems]


# çµæœåæ˜ 
template_tree = ET.ElementTree(template_root)

# ns:0å¯¾ç­–
namespaces = {
    node[0]: node[1] for _, node in ET.iterparse(template_path, events=["start-ns"])
}
for key, value in namespaces.items():
    ET.register_namespace(key, value)

# å‡¡ä¾‹å‡ºåŠ›
legend_output_path = Path("./legend.svg")
template_tree.write(legend_output_path)

# å‡¡ä¾‹éƒ¨åˆ†å‰Šé™¤
info_elems.remove(legend_elems)

# å¤‰æ›´åæ˜ 
tree = ET.ElementTree(root)

# ns:0å¯¾ç­–
target_namespaces = {
    node[0]: node[1] for _, node in ET.iterparse(input_path, events=["start-ns"])
}
for key, value in target_namespaces.items():
    ET.register_namespace(key, value)

# å‡¡ä¾‹ã‚’åˆ‡ã‚Šå–ã£ãŸã‚°ãƒ©ãƒ•å‡ºåŠ›
graph_output_path = Path("./graph.svg")
tree.write(graph_output_path)

```

## SVGã¯XMLã¨ã—ã¦æ“ä½œå¯èƒ½

plotlyã‹ã‚‰å‡¡ä¾‹ã‚’åˆ‡ã‚Šå–ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

SVGã¯XMLã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§å‡¦ç†ãŒã§ãã‚‹äº‹ã‚’ç™ºè¦‹ã—ãŸã®ã§
ä»Šå¾Œã€è‰²ã€…ã¨æ´»ç”¨ã§ããã†ã§ã™ï¼

ä»Šå›ã®ã‚½ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã«ç½®ãã¾ã—ãŸã€‚
https://github.com/nowa0402/plotly_mode
